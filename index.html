<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Code Editor with Tests</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- CodeMirror dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <!-- Add TypeScript support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.0.4/typescript.min.js"></script>

    <!-- Don't use this in production: -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- Add these new dependencies after the existing CodeMirror dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.js"></script>

    <style>
        .container {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .editor-section {
            flex: 1;
        }

        .results-section {
            flex: 1;
        }

        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .test-pass {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .test-fail {
            background-color: #f2dede;
            color: #a94442;
        }

        .readonly-line {
            background-color: rgba(0, 0, 0, 0.1);
            cursor: not-allowed;
        }

        .CodeMirror {
            height: auto;
            min-height: 200px;
            width: 100%;
        }

        .CodeMirror-lint-mark-error {
            border-bottom: 1px solid red;
        }
        
        .CodeMirror-lint-tooltip {
            background-color: #ffd2d2;
            color: #000;
            border: 1px solid #db7272;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        function CodeEditor({ code, onChange }) {
            const editorRef = React.useRef(null);

            React.useEffect(() => {
                const editor = CodeMirror.fromTextArea(editorRef.current, {
                    mode: 'text/typescript',
                    theme: 'monokai',
                    lineNumbers: true,
                    lineWrapping: true,
                    lint: {
                        esversion: 6,
                        async: true,
                        getAnnotations: (content, updateLinting, options, editor) => {
                            const errors = [];
                            try {
                                // Compile TypeScript and get diagnostics
                                const result = ts.transpileModule(content, {
                                    compilerOptions: {
                                        target: ts.ScriptTarget.ES2015,
                                        module: ts.ModuleKind.None,
                                        strict: true
                                    },
                                    reportDiagnostics: true
                                });

                                if (result.diagnostics) {
                                    result.diagnostics.forEach(diagnostic => {
                                        if (diagnostic.file) {
                                            const { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                                            errors.push({
                                                from: CodeMirror.Pos(line, character),
                                                to: CodeMirror.Pos(line, character + 1),
                                                message: ts.flattenDiagnosticMessageText(diagnostic.messageText, '\n'),
                                                severity: 'error'
                                            });
                                        }
                                    });
                                }
                            } catch (e) {
                                console.error('TypeScript compilation error:', e);
                            }
                            updateLinting(editor, errors);
                        }
                    }
                });

                editor.setValue(code);

                // Create read-only ranges for first and last lines
                const lastLine = editor.lineCount() - 1;
                const readOnlyRanges = [
                    {
                        from: { line: 0, ch: 0 },
                        to: { line: 0, ch: Infinity },
                        className: 'readonly-line'
                    },
                    {
                        from: { line: lastLine, ch: 0 },
                        to: { line: lastLine, ch: Infinity },
                        className: 'readonly-line'
                    }
                ];

                // Apply read-only ranges
                readOnlyRanges.forEach(range => {
                    editor.markText(range.from, range.to, {
                        readOnly: true,
                        atomic: true,  // Prevents cursor from entering the range
                        className: range.className
                    });
                });

                editor.on('beforeChange', (cm, change) => {
                    // Prevent any changes to read-only ranges
                    if (change.from.line === 0 || change.to.line === 0 ||
                        change.from.line === lastLine || change.to.line === lastLine) {
                        change.cancel();
                    }
                });

                editor.on('change', () => {
                    onChange(editor.getValue());
                });

                return () => editor.toTextArea();
            }, []);

            return (
                <textarea ref={editorRef} />
            );
        }

        function TestResults({ results }) {
            return (
                <div>
                    <h2>Test Results</h2>
                    {results.map((result, index) => (
                        <div
                            key={index}
                            className={`test-result ${result.passed ? 'test-pass' : 'test-fail'}`}
                        >
                            {result.title}: {result.passed ? 'Passed' : 'Failed'}
                        </div>
                    ))}
                </div>
            );
        }

        function MyApp() {
            const [code, setCode] = React.useState(`function sum(a: number, b: number): number {
  // Write your code here
  return 0;
}`);

            const [testResults, setTestResults] = React.useState([]);

            const runTests = React.useCallback((currentCode) => {
                try {
                    // Compile TypeScript to JavaScript
                    const compiledJS = ts.transpile(currentCode, {
                        target: ts.ScriptTarget.ES2015,
                        module: ts.ModuleKind.None
                    });

                    // Create function from compiled JavaScript
                    const fn = new Function(`return ${compiledJS}`)();

                    const tests = [
                        {
                            title: 'Should add two positive numbers',
                            test: () => fn(2, 3) === 5
                        },
                        {
                            title: 'Should add a positive and a negative number',
                            test: () => fn(-2, 3) === 1
                        }
                    ];

                    const results = tests.map(({ title, test }) => ({
                        title,
                        passed: test()
                    }));

                    setTestResults(results);
                } catch (error) {
                    setTestResults([{
                        title: 'Error',
                        passed: false,
                        error: error.message
                    }]);
                }
            }, []);



            React.useEffect(() => {
                runTests(code);
            }, [code, runTests]);

            return (
                <div className="container">
                    <div className="editor-section">
                        <h2>Code Editor</h2>
                        <CodeEditor
                            code={code}
                            onChange={(newCode) => setCode(newCode)}
                        />
                    </div>
                    <div className="results-section">
                        <TestResults results={testResults} />
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<MyApp />);
    </script>
</body>

</html>